name: Test Pipeline with ChatGPT Troubleshooting

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  failing-step:
    runs-on: ubuntu-latest
    continue-on-error: true
    outputs:
      step-outcome: ${{ steps.intentional-failure.outcome }}
      error-type: ${{ steps.intentional-failure.outputs.error }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Intentional Failure Step
      id: intentional-failure
      continue-on-error: true
      run: |
        echo "Starting deployment process..."
        echo "Checking database connection..."
        
        # Simular diferentes tipos de falhas aleatoriamente
        FAILURE_TYPE=$((RANDOM % 4))
        
        case $FAILURE_TYPE in
          0)
            echo "❌ ERROR: Database connection failed"
            echo "Connection timeout after 30 seconds"
            echo "Host: db.production.com:5432"
            echo "Database: pipeline_ia_prod"
            echo "error=database_connection_timeout" >> $GITHUB_OUTPUT
            exit 1
            ;;
          1)
            echo "❌ ERROR: Missing environment variable"
            echo "Environment variable 'API_SECRET_KEY' is not set"
            echo "Required for authentication with external service"
            echo "error=missing_environment_variable" >> $GITHUB_OUTPUT
            exit 1
            ;;
          2)
            echo "❌ ERROR: Docker build failed"
            echo "Failed to build Docker image"
            echo "Error: COPY failed: no source files were specified"
            echo "Dockerfile line 15: COPY src/ /app/src/"
            echo "error=docker_build_failure" >> $GITHUB_OUTPUT
            exit 1
            ;;
          3)
            echo "❌ ERROR: Permission denied"
            echo "Access denied to production server"
            echo "SSH key authentication failed"
            echo "User: deploy@production-server.com"
            echo "error=permission_denied" >> $GITHUB_OUTPUT
            exit 1
            ;;
        esac


  chatgpt-troubleshooting:
    runs-on: ubuntu-latest
    needs: failing-step
    if: always() && needs.failing-step.outputs.step-outcome == 'failure'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install openai requests
        
    - name: ChatGPT Troubleshooting
      id: troubleshoot
      timeout-minutes: 5
      env:
        ERROR_TYPE: ${{ needs.failing-step.outputs.error-type }}
        WORKFLOW_NAME: ${{ github.workflow }}
        REPOSITORY: ${{ github.repository }}
        BRANCH: ${{ github.ref_name }}
        COMMIT: ${{ github.sha }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      run: |
        python3 scripts/chatgpt_troubleshoot.py
        
    - name: Upload Troubleshooting Report
      if: always() && hashFiles('troubleshooting_report.md') != ''
      uses: actions/upload-artifact@v4
      with:
        name: troubleshooting-report-${{ github.run_number }}
        path: troubleshooting_report.md
        retention-days: 30
        
